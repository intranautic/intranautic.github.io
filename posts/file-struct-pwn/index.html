<!DOCTYPE html>
<html lang="en-us"><head>
  <meta charset="utf-8">
<meta http-equiv="content-type" content="text/html">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title itemprop="name">FILE Structure Exploitation | Intranautic</title>
<meta property="og:title" content="FILE Structure Exploitation | Intranautic" />
<meta name="twitter:title" content="FILE Structure Exploitation | Intranautic" />
<meta itemprop="name" content="FILE Structure Exploitation | Intranautic" />
<meta name="application-name" content="FILE Structure Exploitation | Intranautic" />
<meta property="og:site_name" content="My blog" />

<meta name="description" content="">
<meta itemprop="description" content="" />
<meta property="og:description" content="" />
<meta name="twitter:description" content="" />

<meta property="og:locale" content="en-us" />
<meta name="language" content="en-us" />



  <meta itemprop="image" content="https://intranautic.com/" />
  <meta property="og:image" content="https://intranautic.com/" />
  <meta name="twitter:image" content="https://intranautic.com/" />
  <meta name="twitter:image:src" content="https://intranautic.com/" />




    
    
    
    

    <meta property="og:type" content="article" />
    <meta property="og:article:published_time" content=2023-03-14T00:00:00Z />
    <meta property="article:published_time" content=2023-03-14T00:00:00Z />

    
    <meta property="og:article:author" content="Intranautic" />
    <meta property="article:author" content="Intranautic" />
    <meta name="author" content="Intranautic" />
    

    

    <script defer type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "Article",
        "headline": "FILE Structure Exploitation",
        "author": {
        "@type": "Person",
        "name": ""
        },
        "datePublished": "2023-03-14",
        "description": "",
        "wordCount":  1389 ,
        "mainEntityOfPage": "True",
        "dateModified": "2023-03-14",
        "image": {
        "@type": "imageObject",
        "url": ""
        },
        "publisher": {
        "@type": "Organization",
        "name": "Intranautic"
        }
    }
    </script>

  <meta name="generator" content="Hugo 0.110.0">

  

  <link rel="canonical" href="https://intranautic.com/posts/file-struct-pwn/"><link href="/sass/main.min.e1a241912604fa0730aca01728f78b04c1144d447dd693df07a461d5f7a63544.css" rel="stylesheet"><link href="/code-highlight.min.706d31975fec544a864cb7f0d847a73ea55ca1df91bf495fd12a177138d807cf.css" rel="stylesheet">

  

  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon/favicon-16x16.png">
  <link rel="manifest" href="/images/favicon/site.webmanifest">
  <link rel="mask-icon" href="/images/favicon/safari-pinned-tab.svg" color="#5bbad5">
  <link rel="shortcut icon" href="/images/favicon/favicon.ico">
  <meta name="msapplication-TileColor" content="#2b5797">
  <meta name="msapplication-config" content="/images/favicon/browserconfig.xml">
  <meta name="theme-color" content="#ffffff">

  
  <link rel="icon" type="image/svg+xml" href="/images/favicon/favicon.svg">

  
    </head><body data-theme = "dark" class="notransition">
<script src="https://intranautic.com/js/themeLoader.min.4e9e1a253d543bbfec02e7f2460d9621e719fd739dc8a5256faa91cda6e12e03.js"></script><div class="navbar" role="navigation">
  <nav class="menu" aria-label="Main Navigation">
    <a href="/" class="logo">
      <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" 
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" 
stroke-linejoin="round" class="feather feather-home">
<title>Home</title>
<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
<polyline points="9 22 9 12 15 12 15 22"></polyline>
</svg>
    </a>
    <input type="checkbox" id="menu-trigger" class="menu-trigger" />
    <label for="menu-trigger">
      <span class="menu-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" stroke="currentColor" fill="none" viewBox="0 0 14 14"><title>Menu</title><path stroke-linecap="round" stroke-linejoin="round" d="M10.595 7L3.40726 7"></path><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 3.51488L3.49301 3.51488"></path><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 10.4851H3.49301"></path><path stroke-linecap="round" stroke-linejoin="round" d="M0.5 12.5V1.5C0.5 0.947715 0.947715 0.5 1.5 0.5H12.5C13.0523 0.5 13.5 0.947715 13.5 1.5V12.5C13.5 13.0523 13.0523 13.5 12.5 13.5H1.5C0.947715 13.5 0.5 13.0523 0.5 12.5Z"></path></svg>
      </span>
    </label>

    <div class="trigger">
      <ul class="trigger-container">
        
        
          <li>
            <a 
            class="menu-link "
            href="/">
            Home
            </a>
            
          </li>
        
          <li>
            <a 
            class="menu-link active"
            href="/posts/">
            Posts
            </a>
            
          </li>
        
          <li>
            <a 
            class="menu-link "
            href="/about/">
            About
            </a>
            
          </li>
        
        <li class="menu-separator">
          <span>|</span>
        </li>
      </ul>
      <a id="mode" href="#">
        <svg xmlns="http://www.w3.org/2000/svg" class="mode-sunny" width="21" height="21" viewBox="0 0 14 14" stroke-width="1">
<title>LIGHT</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></circle><line x1="7" y1="0.5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="0.5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line></g></svg>
        <svg xmlns="http://www.w3.org/2000/svg" class="mode-moon" width="21" height="21" viewBox="0 0 14 14" stroke-width="1">
<title>DARK</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></circle><line x1="7" y1="0.5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="0.5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line></g></svg>
      </a>
    </div>
  </nav>
</div>

<div class="wrapper post">
    <main class="page-content" aria-label="Content">
        <article>
            <header class="header">
                <h1 class="header-title">FILE Structure Exploitation</h1>
                
                <div class="post-meta">
                    <time datetime="2023-03-14T00:00:00&#43;00:00" itemprop="datePublished"> Mar 14, 2023 </time>
                </div>
            </header>
            <div class="page-content">
                <h1 id="introduction">Introduction</h1>
<p>The technique known as FILE structure exploitation is a technique which aims to
abuse the FILE struct within libc.</p>
<p>This structure, as well as it&rsquo;s associated set of functions, is used as a buffered
input and output stream. This allows for more optimized i/o as it performs less
read and writes, which allows for less context switching into the kernel.</p>
<p>However, if not used correctly, the FILE structure can be abused to gain various
exploit primitives. This is what we will be exploring today.</p>
<p>But before we delve into the exploitation of the FILE structure, lets first take a
look into it&rsquo;s internal implementation as well as its use cases.</p>
<h1 id="the-file-structure">The FILE Structure</h1>
<p>Lets first take a look at the FILE structure, which is also of type _IO_FILE.</p>
<p><code>https://elixir.bootlin.com/glibc/latest/source/libio/bits/types/struct_FILE.h#L49</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// defined: https://elixir.bootlin.com/glibc/glibc-2.35/source/libio/bits/types/FILE.h#L7
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_IO_FILE</span> <span class="n">FILE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">_IO_FILE</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">_flags</span><span class="p">;</span>		<span class="cm">/* High-order word is _IO_MAGIC; rest is flags. */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/* The following pointers correspond to the C++ streambuf protocol. */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="o">*</span><span class="n">_IO_read_ptr</span><span class="p">;</span>	<span class="cm">/* Current read pointer */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="o">*</span><span class="n">_IO_read_end</span><span class="p">;</span>	<span class="cm">/* End of get area. */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="o">*</span><span class="n">_IO_read_base</span><span class="p">;</span>	<span class="cm">/* Start of putback+get area. */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="o">*</span><span class="n">_IO_write_base</span><span class="p">;</span>	<span class="cm">/* Start of put area. */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="o">*</span><span class="n">_IO_write_ptr</span><span class="p">;</span>	<span class="cm">/* Current put pointer. */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="o">*</span><span class="n">_IO_write_end</span><span class="p">;</span>	<span class="cm">/* End of put area. */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="o">*</span><span class="n">_IO_buf_base</span><span class="p">;</span>	<span class="cm">/* Start of reserve area. */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="o">*</span><span class="n">_IO_buf_end</span><span class="p">;</span>	<span class="cm">/* End of reserve area. */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/* The following fields are used to support backing up and undo. */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="o">*</span><span class="n">_IO_save_base</span><span class="p">;</span> <span class="cm">/* Pointer to start of non-current get area. */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="o">*</span><span class="n">_IO_backup_base</span><span class="p">;</span>  <span class="cm">/* Pointer to first valid character of backup area */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="o">*</span><span class="n">_IO_save_end</span><span class="p">;</span> <span class="cm">/* Pointer to end of non-current get area. */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">_IO_marker</span> <span class="o">*</span><span class="n">_markers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">_IO_FILE</span> <span class="o">*</span><span class="n">_chain</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">_fileno</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">_flags2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">__off_t</span> <span class="n">_old_offset</span><span class="p">;</span> <span class="cm">/* This used to be _offset but it&#39;s too small.  */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/* 1+column number of pbase(); 0 is unknown. */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">_cur_column</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">signed</span> <span class="kt">char</span> <span class="n">_vtable_offset</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">_shortbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">_IO_lock_t</span> <span class="o">*</span><span class="n">_lock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><p>The _flags field actually serves as two fields, the magic which indicates that the
memory is indeed a FILE structure, and the flags which indicates the mode in which
the file is opened. The mode determines which operations will be performed on the
FILE structure.</p>
<p>As of right now, the important fields to focus on are _IO_read_ptr, _IO_read_end,
_IO_read_base, _IO_write_base, _IO_write_ptr, _IO_write_end, _IO_buf_base and
_IO_buf_end.</p>
<blockquote>
<p>Something to note is the fact that in C, stdout, stdin and stderr are all FILE
structures, meaning that they are also buffered. By default, these are line buffered,
but you can change it via setvbuf.</p>
</blockquote>
<p>Now, we had previously stated that buffering was a vital optimization that these FILE
structures allow us to utilize. The kinds of buffering are explained below.</p>
<p>unbuffered - Calls write system call as soon as possible, does not cache in buffer.
line buffered - Writes when a newline is encountered or the buffer is full.
fully buffered - Writes content of buffer only when the FILE buffer is full.</p>
<blockquote>
<p>Another thing to note is the fact that each of the FILE strucutures within the process
are chained together as a singly linked list. The global variable which hold the head
of the list is <code>_IO_list_all</code>. The head of the chain will point towards the standard
streams that had been explained above, as they are always present within a binary at
compile time. The definition for <code>_IO_list_all</code> is as shown below.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">_IO_FILE_plus</span> <span class="o">*</span><span class="n">_IO_list_all</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">_IO_2_1_stderr_</span><span class="p">;</span>
</span></span></code></pre></div><p>We can see that the field struct _IO_FILE *chain within the FILE structure acts as
a pointer to the next entry within the list of files.</p>
<p>The _fileno field within the FILE structure acts as the raw file descriptor for our
open file in which we want to operate on. Remember that this FILE structure simply
acts as a stream wrapper which optimizes i/o operations via buffering.</p>
<h1 id="the-file-plus-structure">The FILE Plus Structure</h1>
<p>The _IO_FILE structure is also wrapped around another struct named _IO_FILE_plus.
It&rsquo;s purpose and implementation is fairly simply, we can see it&rsquo;s definition below.</p>
<p><code>https://elixir.bootlin.com/glibc/glibc-2.31/source/libio/libioP.h#L324</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">_IO_FILE_plus</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">_IO_FILE</span> <span class="n">file</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">IO_jump_t</span><span class="o">*</span> <span class="n">vtable</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><p>We can see that it contains a the FILE structure we had discussed before and a new
field named vtable. This is identical to the concept of virtual tables within C++,
as it allows for runtime polymorphism of class members. In other words, its a table
of function pointers which is contained within mutable memory and can dynamically
change at runtime.</p>
<p>The _IO_2_1_stderr, _IO_2_1_stdout and _IO_2_1_stdin FILE structures are
of the type FILE_plus, as well as any other FILE structure returned by fopen.</p>
<p>The following is the definition of the vtable&rsquo;s IO_jump_t.</p>
<p><code>https://elixir.bootlin.com/glibc/glibc-2.31/source/libio/libioP.h#L293</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// defined at: https://elixir.bootlin.com/glibc/glibc-2.31/source/libio/libioP.h#L122
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define JUMP_FIELD(TYPE, NAME) TYPE NAME
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">_IO_jump_t</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_FIELD</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">__dummy</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_FIELD</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">__dummy2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_finish_t</span><span class="p">,</span> <span class="n">__finish</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_overflow_t</span><span class="p">,</span> <span class="n">__overflow</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_underflow_t</span><span class="p">,</span> <span class="n">__underflow</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_underflow_t</span><span class="p">,</span> <span class="n">__uflow</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_pbackfail_t</span><span class="p">,</span> <span class="n">__pbackfail</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/* showmany */</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_xsputn_t</span><span class="p">,</span> <span class="n">__xsputn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_xsgetn_t</span><span class="p">,</span> <span class="n">__xsgetn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_seekoff_t</span><span class="p">,</span> <span class="n">__seekoff</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_seekpos_t</span><span class="p">,</span> <span class="n">__seekpos</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_setbuf_t</span><span class="p">,</span> <span class="n">__setbuf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_sync_t</span><span class="p">,</span> <span class="n">__sync</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_doallocate_t</span><span class="p">,</span> <span class="n">__doallocate</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_read_t</span><span class="p">,</span> <span class="n">__read</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_write_t</span><span class="p">,</span> <span class="n">__write</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_seek_t</span><span class="p">,</span> <span class="n">__seek</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_close_t</span><span class="p">,</span> <span class="n">__close</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_stat_t</span><span class="p">,</span> <span class="n">__stat</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_showmanyc_t</span><span class="p">,</span> <span class="n">__showmanyc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_imbue_t</span><span class="p">,</span> <span class="n">__imbue</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><p>We can see that the type for the virtual table consists of function pointers for
various operations and helper functions which may be performed on the FILE. The
function that is called will be determined by the offset from the virtual table.</p>
<p>Remember this, as it will come in handy later when we learn more about exploiting
the FILE structure.</p>
<h1 id="file-operations">FILE Operations</h1>
<p>Now that we understand the general structure of FILE, lets understand the internal
mechanisms.</p>
<p>First, lets take a look at the fread operation, the following is an example of
it&rsquo;s usage as well as a function to write out the FILE structure&rsquo;s internal fields.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">dump_file_struct</span><span class="p">(</span><span class="n">FILE</span><span class="o">*</span> <span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Magic: %#lx</span><span class="se">\n</span><span class="s">Flags: %#d</span><span class="se">\n</span><span class="s">Read Pointer: %#lx</span><span class="se">\n</span><span class="s">Read End: %#lx</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">         <span class="s">&#34;Read Base: %#lx</span><span class="se">\n</span><span class="s">Write Base: %#lx</span><span class="se">\n</span><span class="s">Write Pointer: %#lx</span><span class="se">\n</span><span class="s">Write End: %#lx</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="s">&#34;Buffer Base: %#lx</span><span class="se">\n</span><span class="s">Buffer End: %#lx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_base</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_write_base</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_write_ptr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_write_end</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_end</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">FILE</span><span class="o">*</span> <span class="n">fp</span> <span class="o">=</span> <span class="nf">fopen</span><span class="p">(</span><span class="s">&#34;/dev/stdin&#34;</span><span class="p">,</span> <span class="s">&#34;r&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Input 8 bytes: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;read %d bytes @ %p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">fread</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">),</span> <span class="mi">8</span><span class="p">,</span> <span class="n">fp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">dump_file_struct</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Error, something went wrong..&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Lets run the example and check out the internal pointers held within the FILE structure.</p>
<pre tabindex="0"><code>Input 8 bytes: AAAAAAAA
read 8 bytes @ 0x7ffe5ee95550
Magic: 0xfbad
Flags: 9864
Read Pointer: 0x55dcd38a7898
Read End: 0x55dcd38a7899
Read Base: 0x55dcd38a7890
Write Base: 0x55dcd38a7890
Write Pointer: 0x55dcd38a7890
Write End: 0x55dcd38a7890
Buffer Base: 0x55dcd38a7890
Buffer End: 0x55dcd38a7c90
</code></pre><p>We can see that the read pointer has been incremented by 8 bytes, which is the exact
number of bytes read by <code>fread</code>. With this we know that each time we read from the
FILE, it will increment the read pointer by the amount of bytes read. The next time
we call fread on this file it will continue to read from the _IO_read_ptr pointer.</p>
<p>Something else that we can notice is the fact that _IO_read_end is not the same as
_IO_buf_end. With this, we can tell that the state of the FILE structure looks
similar to the diagram shown below (disregarding the write pointers).</p>
<p><img src="/assets/img/file-struct-pwn-0.png" alt="file struct diagram"></p>
<p>The same can be through of for fwrite , it will undergo a similar procedure except
the write fields will be updated.</p>
<p>When fopen is called, it will initialize depending on the mode which was used to
open the file. At a high level, it will initialize the various fields of the FILE
structure, including the population of the vtable field with a default virtual table.</p>
<blockquote>
<p>It is highly recommended that you view the source of fopen to gain a better
understanding of its internal operations.</p>
</blockquote>
<p><code>https://elixir.bootlin.com/glibc/latest/source/libio/iofopen.c#L56</code></p>
<p>The definition for this virtual table is shown below.</p>
<p><code>https://elixir.bootlin.com/glibc/latest/source/libio/tst-vtables-common.c#L296</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">_IO_jump_t</span> <span class="n">jumps</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">JUMP_INIT_DUMMY</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_INIT</span> <span class="p">(</span><span class="n">finish</span><span class="p">,</span> <span class="n">method_finish</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_INIT</span> <span class="p">(</span><span class="n">overflow</span><span class="p">,</span> <span class="n">method_overflow</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_INIT</span> <span class="p">(</span><span class="n">underflow</span><span class="p">,</span> <span class="n">method_underflow</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_INIT</span> <span class="p">(</span><span class="n">uflow</span><span class="p">,</span> <span class="n">method_uflow</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_INIT</span> <span class="p">(</span><span class="n">pbackfail</span><span class="p">,</span> <span class="n">method_pbackfail</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_INIT</span> <span class="p">(</span><span class="n">xsputn</span><span class="p">,</span> <span class="n">method_xsputn</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_INIT</span> <span class="p">(</span><span class="n">xsgetn</span><span class="p">,</span> <span class="n">method_xsgetn</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_INIT</span> <span class="p">(</span><span class="n">seekoff</span><span class="p">,</span> <span class="n">method_seekoff</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_INIT</span> <span class="p">(</span><span class="n">seekpos</span><span class="p">,</span> <span class="n">method_seekpos</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_INIT</span> <span class="p">(</span><span class="n">setbuf</span><span class="p">,</span> <span class="n">method_setbuf</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_INIT</span> <span class="p">(</span><span class="n">sync</span><span class="p">,</span> <span class="n">method_sync</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_INIT</span> <span class="p">(</span><span class="n">doallocate</span><span class="p">,</span> <span class="n">method_doallocate</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_INIT</span> <span class="p">(</span><span class="n">read</span><span class="p">,</span> <span class="n">method_read</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_INIT</span> <span class="p">(</span><span class="n">write</span><span class="p">,</span> <span class="n">method_write</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_INIT</span> <span class="p">(</span><span class="n">seek</span><span class="p">,</span> <span class="n">method_seek</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_INIT</span> <span class="p">(</span><span class="n">close</span><span class="p">,</span> <span class="n">method_close</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_INIT</span> <span class="p">(</span><span class="n">stat</span><span class="p">,</span> <span class="n">method_stat</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_INIT</span> <span class="p">(</span><span class="n">showmanyc</span><span class="p">,</span> <span class="n">method_showmanyc</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_INIT</span> <span class="p">(</span><span class="n">imbue</span><span class="p">,</span> <span class="n">method_imbue</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><h1 id="arbitrary-read-and-write-with-file-structure">Arbitrary Read and Write with FILE structure</h1>
<p>Now that we understand the FILE structure, we can explore how we can abuse this
structure to gain various exploit primitives. The first technique we will be exploring
will be an arbitrary read and write primitive via the FILE struct.</p>
<h1 id="pc-hijack-via-file_plus-and-the-vtable">PC Hijack via FILE_plus and the vtable</h1>
<h1 id="bypassing-virtual-table-check">Bypassing virtual table check</h1>
<h1 id="file-stream-oriented-programming">FILE Stream Oriented Programming</h1>

            </div>
        </article>
    </main>
</div>
<footer class="footer">
    <span class="footer_item"> </span>
    &nbsp;

    <div class="footer_social-icons">
<a href="https://github.com/intranautic" target="_blank" rel="noopener noreferrer me" title="Github">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path
        d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22">
    </path>
</svg>
</a>
<a href="https://twitter.com/intranautic" target="_blank" rel="noopener noreferrer me" title="Twitter">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path
        d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z">
    </path>
</svg>
</a>
<a href="https://keybase.io/intranautic" target="_blank" rel="noopener noreferrer me" title="Keybase">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 71 76.3" version="1.1" fill="currentColor" stroke="none">
    <path
        d="M6.68 73.99c-.6-1.3-1.4-3.1-1.8-4l-.6-1.7-2 2.2-2 2.2-.2-4.2c-.3-6 .2-12.2 1.2-16.6 2.3-9.8 9.5-18.7 18.8-23.4l2.1-1-.5-1.5c-.3-.8-.6-2.5-.7-3.6l-.2-2.1-2.1-.2c-3.2-.3-4.9-1.2-6-3.5-.6-1.2-.6-1.4-.4-4.6.2-4.2.5-5.1 1.8-6.5 1.6-1.8 2.7-2.1 6.7-1.9 2.9.2 3.5.3 4.8.9.8.4 1.5.8 1.6.8.1 0 1-1.1 2.1-2.6l1.9-2.7 1.2.7c.7.4 1.5.9 1.9 1.1l.7.4-.6 1.5c-.3.8-.7 2.2-.8 2.9l-.2 1.4 1.7.2c6.1.6 10.7 4.3 12.4 9.9.5 1.8.5 5.3 0 7-.5 1.6-.5 1.7-.1 1.7.7 0 5.4 2.3 7.3 3.5 3.7 2.4 8 6.6 10.4 10.2 4.5 6.7 6.4 14 5.6 22-.4 4.8-1.3 8.6-2.9 12.3l-.6 1.4h-5l1.2-2.4c1.3-2.6 2.3-6.2 2.8-9.4.3-2.2.4-8.2.1-9.3l-.2-.7-1.3 1.4c-3.2 3.5-7.9 4.5-14.2 2.8-5.4-1.4-7.6-1.7-12.7-1.7-3.9 0-5.2.1-7.3.6-5.8 1.3-9.9 3.2-15.6 7.3-2.1 1.5-3.8 2.7-3.9 2.7-.1 0 .2-1 .6-2.3.4-1.3 1.1-3.4 1.5-4.8l.8-2.5-.9.9c-.5.5-1.9 1.9-3.1 3.2l-2.1 2.3.5 1.9c.6 2.5 2 5.6 3.5 7.9.6 1 1.1 1.8 1.1 1.9s-1.2.1-2.6.1h-2.6l-1.1-2.1zm8.8-24.2c4.8-5.1 8.7-9.2 8.8-9.2.1.1-.4 1.6-.9 3.3-3.3 10.4-4 12.4-3.9 12.5 0 0 1.2-.4 2.5-.9 8.5-3.7 18.4-4.2 28.9-1.4 4.7 1.2 6.5 1.2 8.8 0 1.3-.7 1.8-1.1 2.4-2.1 1.1-1.7 1.2-4.1.5-6.3-1.7-4.8-8.3-11-14.5-13.7-3.2-1.4-3.4-1.4-4.1-.7l-.6.6 2.6 3.2c1.4 1.7 2.9 3.6 3.1 4.1.6 1.2.7 3.1.1 4.3-.8 1.7-3.2 2.9-5.1 2.5-.8-.2-1.1-.1-1.9.5-2.2 1.6-4.6 1.2-6.6-1.2-1.6-1.8-2-2.7-2.1-4.5 0-.9-.3-2-.5-2.4-.3-.6-.4-1.3-.4-2.2l.1-1.4-1.3-.3c-1.8-.5-3.9-1.5-5.1-2.4-.6-.4-1.1-.8-1.3-.8s-1.5.6-2.9 1.3c-9.7 5-16 14.3-17 24.8-.1 1-.2 2.3-.3 2.8l-.1.9 1.1-1.1c.5-.5 4.9-5.1 9.7-10.2zm25.9-7.4c.9-.7 1.7-1.3 1.9-1.3.1 0 .4.3.7.7.5.8 1.4.8 1.8.1.3-.5.3-.6-5.6-7.8-3.5-4.3-4.2-5-4.7-5-1.2.1-.9 1 1 3.3l1.8 2.2-1 .8c-1.1 1-1.2 1.2-.5 1.8.5.5.6.4 1.6-.3l1.1-.7.7.6c.4.3.6.8.6.9 0 .2-.8.9-1.7 1.7-.9.7-1.6 1.5-1.6 1.7 0 .3.5 1.1 1.4 2.2.3.6.8.4 2.5-.9zm-10.3-14.2c.6-1.8 2.6-3.2 4.6-3.2 1.1 0 2.7.9 3.8 2.1l1 1.2.9-1.1c2.5-2.8 2.8-6.7.8-10.1-1.5-2.5-4.3-4-8.2-4.4-2.1-.2-2.6-.4-3.7-1.5l-.8-.8-.4.6c-.8 1.2-2.5 5.1-3 6.6-.7 2.3-.4 5.9.5 7.7.9 1.7 3.3 4 4 3.7.1.1.3-.3.5-.8zm-8.9-13.6c.2-.5.7-1.8 1.2-2.8.5-1 .9-2 .9-2.3 0-.9-1-1.3-3.7-1.5-2.4-.2-2.6-.1-3.1.4-.4.4-.6.9-.6 1.6 0 .6-.1 1.7-.2 2.6-.2 2.1.1 2.5 2.2 2.8 3.1.2 3 .2 3.3-.8zm-3.1-2.4c0-1.7.2-1.9 1.6-1.9h1.3v2.8h-2.8v-.9zm6.3 58.3c-.6-.6-.8-1-.8-2 0-1.9 1.1-3 2.9-3 1.7 0 2.9 1.2 2.9 2.9 0 1.8-1.1 2.8-3 2.9-1 0-1.4-.2-2-.8zm19.3.3a2.93 2.93 0 011.8-5.3c1.8 0 2.8 1.1 2.9 3 0 1.1-.1 1.4-.8 2s-1 .8-2 .8c-.9 0-1.5-.2-1.9-.5z" />
</svg>
</a>
<a href="https://www.youtube.com/channel/UCHeF3c8S4R031ENxz6FWj-w" target="_blank" rel="noopener noreferrer me" title="Youtube">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path
        d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .46 5.33A2.78 2.78 0 0 0 3.4 19c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 0 0 1.94-2 29 29 0 0 0 .46-5.25 29 29 0 0 0-.46-5.33z">
    </path>
    <polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02"></polygon>
</svg>
</a>
<a href="/pgp.txt" target="_blank" rel="noopener noreferrer me" title="Pgp">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
</svg>
</a>
<a href="/index.xml" target="_blank" rel="noopener noreferrer me" title="Rss">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path d="M4 11a9 9 0 0 1 9 9" />
    <path d="M4 4a16 16 0 0 1 16 16" />
    <circle cx="5" cy="19" r="1" />
</svg>
</a></div>
    <small class="footer_copyright">
        Â© 2023 Intranautic.
        Powered by <a href="https://github.com/hugo-sid/hugo-blog-awesome" target="_blank" rel="noreferrer noopener">Hugo blog awesome</a>
        theme on
        <a href="https://gohugo.io" target="_blank" rel="noreferrer noopener">Hugo</a>.
    </small>
</footer>
<script src="https://intranautic.com/js/themeSwitchnMenu.min.2a402288242b6930b175a0722c267e2353055739b3975834df35e56d00dd8f50.js"></script></body>
</html>
